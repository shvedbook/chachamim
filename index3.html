<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>משחק הכנה לראיון FP&A - גרסה מתקדמת</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Assistant', sans-serif;
        }
        .answer-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .correct {
            animation: pulse-green 0.8s;
        }
        .incorrect {
            animation: shake 0.5s;
        }
        @keyframes pulse-green {
            0% { box-shadow: 0 0 0 0 rgba(74, 222, 128, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(74, 222, 128, 0); }
            100% { box-shadow: 0 0 0 0 rgba(74, 222, 128, 0); }
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            50% { transform: translateX(5px); }
            75% { transform: translateX(-5px); }
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4f46e5;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .gemini-btn {
            background-color: #f0f4ff;
            color: #4338ca;
            border: 1px solid #c7d2fe;
        }
        .gemini-btn:hover {
            background-color: #e0e7ff;
        }
    </style>
</head>
<body class="bg-slate-100 flex items-center justify-center min-h-screen p-4">

    <div id="quiz-container" class="w-full max-w-2xl bg-white rounded-2xl shadow-xl p-6 md:p-8 transition-all duration-500">
        
        <div id="start-screen">
            <h1 class="text-3xl font-bold text-slate-800 text-center mb-4">מוכנים לאתגר? בחינת ידע מתקדמת ב-FP&A</h1>
            <p class="text-slate-600 text-center mb-8">20 שאלות ברמה גבוהה שיכינו אתכם לתרחישים מורכבים בראיון העבודה.</p>
            <button id="start-btn" class="w-full bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg text-lg hover:bg-indigo-700 transition-colors duration-300 shadow-md">
                התחל את האתגר
            </button>
        </div>

        <div id="game-screen" class="hidden">
            <!-- Header -->
            <div class="flex justify-between items-center mb-6">
                <div id="question-counter" class="text-sm font-semibold text-slate-500">שאלה 1/20</div>
                <div id="score" class="text-sm font-semibold text-slate-500">ניקוד: 0</div>
            </div>

            <!-- Progress Bar -->
            <div class="w-full bg-slate-200 rounded-full h-2.5 mb-6">
                <div id="progress-bar" class="bg-indigo-500 h-2.5 rounded-full" style="width: 5%"></div>
            </div>

            <!-- Question -->
            <h2 id="question-text" class="text-2xl font-bold text-slate-800 mb-6 min-h-[100px]"></h2>

            <!-- Answers -->
            <div id="answers-container" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Answer buttons will be inserted here -->
            </div>
            
            <!-- Feedback -->
            <div id="feedback-container" class="mt-6 p-4 rounded-lg text-left min-h-[100px] hidden">
                 <p id="feedback-text" class="font-semibold text-center"></p>
                 <p id="explanation-text" class="text-sm mt-2 text-center"></p>
                 <button id="deeper-explanation-btn" class="w-full md:w-auto mx-auto mt-4 gemini-btn font-bold py-2 px-4 rounded-lg text-sm transition-colors duration-300 hidden">
                    ✨ בקש הסבר מעמיק
                 </button>
                 <div id="gemini-explanation-output" class="mt-4 p-3 bg-slate-50 rounded-md text-sm text-slate-700 hidden text-right"></div>
            </div>


            <!-- Next Button -->
            <button id="next-btn" class="w-full mt-6 bg-slate-700 text-white font-bold py-3 px-6 rounded-lg text-lg hover:bg-slate-800 transition-colors duration-300 shadow-md hidden">
                השאלה הבאה
            </button>
        </div>
        
        <div id="end-screen" class="hidden text-center">
            <h1 class="text-3xl font-bold text-slate-800 mb-4">כל הכבוד! סיימתם את האתגר.</h1>
            <p class="text-slate-600 text-xl mb-2">הניקוד הסופי שלכם הוא:</p>
            <p id="final-score" class="text-5xl font-extrabold text-indigo-600 mb-8"></p>
            <button id="study-plan-btn" class="w-full mb-4 gemini-btn font-bold py-3 px-6 rounded-lg text-lg transition-colors duration-300 shadow-md">
                 ✨ קבל תוכנית למידה אישית
            </button>
            <button id="restart-btn" class="w-full bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg text-lg hover:bg-indigo-700 transition-colors duration-300 shadow-md">
                שחק שוב
            </button>
             <div id="gemini-study-plan-output" class="mt-6 p-4 bg-slate-50 rounded-lg text-right hidden"></div>
        </div>
    </div>

    <script>
        const questions = [
            // --- Basic Concepts (Refresher) ---
            {
                question: "מה ההבדל המהותי בין Gross Margin (רווח גולמי) לבין Contribution Margin (רווח תרומה)?",
                answers: [
                    { text: "אין הבדל מהותי, אלו שני שמות לאותו מדד", correct: false, explanation: "אלו שני מדדים שונים. רווח תרומה מנכה גם עלויות משתנות נוספות מעבר ל-COGS." },
                    { text: "רווח גולמי מחושב לפני COGS, ורווח תרומה אחריו", correct: false, explanation: "שני המדדים מחושבים לאחר ניכוי COGS. ההבדל הוא בהוצאות המשתנות הנוספות." },
                    { text: "רווח תרומה מנכה גם הוצאות מכירה ושיווק משתנות, בעוד רווח גולמי לא", correct: true, explanation: "" },
                    { text: "רווח גולמי משמש למותגים ורווח תרומה משמש לערוצים", correct: false, explanation: "ניתן ורצוי לחשב את שני המדדים גם למותגים וגם לערוצים כדי לקבל תמונה מלאה." }
                ]
            },
            {
                question: "חברה הצליחה להאריך את ימי האשראי לספקים (DPO) מ-60 ל-90 יום. מה ההשפעה המיידית על מחזור המרת המזומן (CCC)?",
                answers: [
                    { text: "ה-CCC יתארך", correct: false, explanation: "הארכת ימי אשראי ספקים (DPO) משפרת את תזרים המזומנים ומקצרת את ה-CCC, מכיוון שהכסף נשאר בחברה לזמן רב יותר." },
                    { text: "ה-CCC יתקצר", correct: true, explanation: "לפי הנוסחה CCC = DIO + DSO - DPO, הגדלת ה-DPO מקטינה את התוצאה הסופית." },
                    { text: "לא תהיה השפעה על ה-CCC", correct: false, explanation: "ל-DPO יש השפעה ישירה ומשמעותית על ה-CCC." },
                    { text: "ה-DSO (ימי חוב לקוחות) יתקצר גם הוא", correct: false, explanation: "אין קשר ישיר בין תנאי התשלום לספקים לבין מהירות הגבייה מלקוחות." }
                ]
            },
            {
                question: "ניתוח PVM (Price/Volume/Mix) הראה שצמיחת ההכנסות נבעה כולה מאפקט 'Price'. מה הסיכון הפוטנציאלי במצב כזה?",
                answers: [
                    { text: "שחיקה ברווחיות הגולמית", correct: false, explanation: "העלאת מחירים לרוב משפרת את הרווחיות הגולמית בטווח הקצר, לא שוחקת אותה." },
                    { text: "ירידה בנתח השוק עקב פגיעה בתחרותיות", correct: true, explanation: "אם המתחרים לא העלו מחירים, הלקוחות עלולים לעבור אליהם והכמות (Volume) תיפגע בעתיד." },
                    { text: "גידול בעלויות המשתנות", correct: false, explanation: "אפקט המחיר אינו קשור ישירות לעלויות המשתנות, אלא למחיר המכירה ללקוח." },
                    { text: "קושי בניהול מלאי", correct: false, explanation: "הסיכון העיקרי הוא תחרותי. ייתכן שבעתיד תהיה השפעה על המלאי אם הכמויות ירדו, אך זה לא הסיכון המיידי." }
                ]
            },
            // --- Intermediate Scenarios ---
            {
                question: "הרווח הגולמי כאחוז מהמכירות יורד, אך רווח התרומה כאחוז מהמכירות נשאר יציב. מהי הסיבה הסבירה ביותר?",
                answers: [
                    { text: "ההשקעה במבצעים ובהנחות לקמעונאים גדלה", correct: false, explanation: "השקעה גדולה יותר במבצעים הייתה פוגעת ברווח התרומה, מכיוון שהיא נחשבת הוצאה משתנה." },
                    { text: "עליית מחירי חומרי הגלם (COGS)", correct: true, explanation: "עלייה ב-COGS פוגעת ישירות ברווח הגולמי, אך אם הוצאות השיווק המשתנות נשארו יציבות ביחס למכירות, אחוז רווח התרומה יכול להישאר יציב." },
                    { text: "גידול בהוצאות הנהלה וכלליות (Opex)", correct: false, explanation: "הוצאות Opex אינן משפיעות על הרווח הגולמי או על רווח התרומה." },
                    { text: "שינוי בתמהיל המכירות לטובת מוצרים זולים יותר", correct: false, explanation: "שינוי כזה היה פוגע גם ברווח הגולמי וגם ברווח התרומה." }
                ]
            },
            {
                question: "מדוע ניטור הפער בין Sell-in ל-Sell-out קריטי במיוחד *לפני* השקה של מוצר חדש ומשמעותי?",
                answers: [
                    { text: "כדי לוודא שהקמעונאים משלמים בזמן", correct: false, explanation: "תשלומים קשורים ל-DSO, לא לפער בין סוגי המכירות." },
                    { text: "כדי למנוע מצב של 'חנק' המדפים במלאי קיים שיפגע בהשקה", correct: true, explanation: "אם המדפים של הקמעונאי מלאים בסחורה ישנה (Sell-in גבוה מ-Sell-out), לא יהיה לו מקום או תמריץ להזמין את המוצר החדש." },
                    { text: "כדי לחשב את ה-Promo ROI של ההשקה מראש", correct: false, explanation: "לא ניתן לחשב ROI לפני שההשקה התרחשה והתקבלו נתוני מכירות." },
                    { text: "כדי לקבוע את מחיר המכירה של המוצר החדש", correct: false, explanation: "תמחור נקבע על בסיס עלויות, תחרות וערך ללקוח, לא על בסיס נתוני מלאי היסטוריים." }
                ]
            },
             {
                question: "חברה השיקה קמפיין עם Promo ROI חיובי, אך מכירות הקטגוריה כולה באותה רשת נשארו ללא שינוי. מהי התופעה הסבירה ביותר?",
                answers: [
                    { text: "נתוני ה-Sell-out אינם אמינים", correct: false, explanation: "זו אפשרות, אך ישנה תופעה כלכלית סבירה יותר." },
                    { text: "הקמפיין משך לקוחות חדשים לקטגוריה", correct: false, explanation: "אם לקוחות חדשים היו נכנסים לקטגוריה, סך המכירות היה עולה." },
                    { text: "קניבליזציה: המבצע גרם ללקוחות לקנות את המוצר שבמבצע במקום מוצר אחר של אותה חברה", correct: true, explanation: "הלקוחות פשוט החליפו מוצר יקר במוצר שבמבצע, כך שהחברה לא הרוויחה מכירות חדשות אמיתיות (אינקרמנטליות)." },
                    { text: "המתחרים הגיבו במבצע אגרסיבי משלהם", correct: false, explanation: "אם המתחרים היו מגיבים, סביר להניח שסך מכירות הקטגוריה היה דווקא עולה עקב המבצעים." }
                ]
            },
            {
                question: "בתרחיש של אינפלציה ועליית מחירי חומרי גלם, איזו פעולה תהיה האפקטיבית ביותר להגנה על אחוז הרווח הגולמי (Gross Margin %)?",
                answers: [
                    { text: "הגדלת ההשקעה ב-Trade Spend כדי להגדיל את נתח השוק", correct: false, explanation: "הגדלת Trade Spend תקטין את ה-Net Sales ותפגע עוד יותר באחוז הרווח הגולמי." },
                    { text: "העלאת מחיר מחירון (Price Increase) במקביל למשא ומתן על עלויות עם ספקים", correct: true, explanation: "זוהי אסטרטגיה משולבת הפועלת גם על שורת ההכנסות (העלאת מחיר) וגם על שורת ה-COGS (הוזלת עלויות)." },
                    { text: "הגדלת ימי אשראי ללקוחות (DSO) כדי לעודד מכירות", correct: false, explanation: "זה אולי יתמוך בכמות המכירות, אך יפגע בתזרים המזומנים ולא יפתור את בעיית הרווחיות." },
                    { text: "צמצום תקציב השיווק", correct: false, explanation: "צמצום תקציב השיווק ישפיע על רווח התרומה או הרווח התפעולי, אך לא יפתור את הבעיה ברווח הגולמי הנגרמת מעליית COGS." }
                ]
            },
            // --- Advanced & Strategic ---
            {
                question: "מהו החיסרון המרכזי בהסתמכות על תחזית המבוססת על YoY (צמיחה שנתית) בלבד, מבלי להתחשב ב-Run-rate?",
                answers: [
                    { text: "התחזית לא תהיה מדויקת ברמה החודשית", correct: false, explanation: "החיסרון הוא מהותי יותר מסתם דיוק חודשי." },
                    { text: "השיטה מתעלמת משינויי מומנטום ומגמות עדכניות מהחודשים האחרונים", correct: true, explanation: "YoY מסתכל על מה שקרה לפני שנה, בעוד Run-rate לוקח בחשבון את הביצועים העכשוויים, שיכולים להיות שונים לחלוטין." },
                    { text: "השיטה אינה לוקחת בחשבון עונתיות", correct: false, explanation: "להיפך, YoY הוא דרך פשוטה לקחת בחשבון עונתיות על ידי השוואה לאותה תקופה בשנה שעברה." },
                    { text: "קשה לחשב YoY אם החברה חדשה", correct: false, explanation: "זהו קושי טכני, אך לא החיסרון המרכזי של השיטה עבור חברה קיימת." }
                ]
            },
            {
                question: "אתה מתבקש לנתח כדאיות של השקת מוצר 'Value' (זול יותר) למותג קיים. מהו הסיכון הפיננסי הגדול ביותר שיש למדל?",
                answers: [
                    { text: "עלויות ייצור גבוהות מהצפוי", correct: false, explanation: "זהו סיכון תפעולי חשוב, אך יש סיכון פיננסי-אסטרטגי גדול יותר." },
                    { text: "שחיקת תמהיל (Mix Erosion) וקניבליזציה של מוצרי הפרימיום הרווחיים יותר", correct: true, explanation: "הסיכון הגדול הוא שלקוחות קיימים יפסיקו לקנות את המוצר היקר והרווחי ויעברו לגרסה הזולה, מה שיפגע בסך הרווח של החברה." },
                    { text: "תגובת המתחרים בשוק ה-Value", correct: false, explanation: "זהו סיכון שוקי חשוב, אך הסיכון הפנימי של קניבליזציה הוא לרוב הגדול והנשלט ביותר." },
                    { text: "קושי להשיג דמי מידוף מהקמעונאים", correct: false, explanation: "זהו סיכון מסחרי. הסיכון הפיננסי המרכזי הוא השפעת ההשקה על כלל רווחיות המותג." }
                ]
            },
            {
                question: "בניית מודל תחזית פיננסי באקסל. מהי הדרך המומלצת למדל תרחישים (אופטימי, בסיסי, פסימי)?",
                answers: [
                    { text: "ליצור שלושה קבצי אקסל נפרדים, אחד לכל תרחיש", correct: false, explanation: "זוהי פרקטיקה גרועה מאוד, מקשה על עדכונים ומגדילה את הסיכוי לטעויות." },
                    { text: "להשתמש בפונקציית IF מקוננת ארוכה בכל תא", correct: false, explanation: "זה אפשרי אך מסורבל מאוד לתחזוקה ולבדיקה." },
                    { text: "להשתמש בתא קלט לבחירת תרחיש (1-3) ופונקציית CHOOSE או INDEX/MATCH כדי למשוך את ההנחה המתאימה", correct: true, explanation: "זוהי הדרך המקצועית והגמישה ביותר, המאפשרת לעבור בין תרחישים בקלות על ידי שינוי של תא אחד בלבד." },
                    { text: "להשתמש ב-Pivot Table כדי לסכם את התרחישים", correct: false, explanation: "Pivot Table משמש לסיכום וניתוח נתונים קיימים, לא לבניית מודל תחזית דינמי." }
                ]
            },
            {
                question: "מהי 'אינקרמנטליות' בהקשר של מדידת ROI לקמפיין דיגיטלי?",
                answers: [
                    { text: "סך המכירות שנוצרו דרך האתר בתקופת הקמפיין", correct: false, explanation: "זה כולל גם מכירות שהיו קורות בכל מקרה. אינקרמנטליות מודדת רק את התוספת." },
                    { text: "העלייה במכירות בהשוואה לתקופה המקבילה אשתקד (YoY)", correct: false, explanation: "השוואת YoY לא מבודדת את השפעת הקמפיין מהשפעות אחרות (כמו עונתיות, פעילות מתחרים וכו')." },
                    { text: "המכירות הנוספות שנוצרו *אך ורק* בזכות הקמפיין, אשר לא היו מתרחשות בלעדיו", correct: true, explanation: "" },
                    { text: "מספר הקליקים שהמודעה קיבלה", correct: false, explanation: "קליקים הם מדד ביצוע (KPI) של הקמפיין, אך לא המכירות האינקרמנטליות." }
                ]
            },
             {
                question: "מהי המשמעות האסטרטגית של מחזור המרת מזומן (CCC) שלילי?",
                answers: [
                    { text: "החברה נמצאת במשבר נזילות חמור", correct: false, explanation: "להיפך. CCC שלילי הוא מצב נזילות מצוין." },
                    { text: "החברה לא מצליחה למכור את המלאי שלה", correct: false, explanation: "מכירת מלאי איטית (DIO גבוה) הייתה מאריכה את ה-CCC, לא הופכת אותו לשלילי." },
                    { text: "החברה מקבלת תשלום מלקוחותיה לפני שהיא צריכה לשלם לספקיה", correct: true, explanation: "מודל עסקי כזה (שנפוץ אצל קמעונאים גדולים למשל) מאפשר לחברה לממן את הפעילות שלה על חשבון הספקים." },
                    { text: "זוהי טעות חשבונאית, CCC לא יכול להיות שלילי", correct: false, explanation: "CCC שלילי הוא אפשרי ואף רצוי מאוד, ומעיד על מודל עסקי יעיל מאוד מבחינת תזרים." }
                ]
            },
            {
                question: "חברה רוצה לשפר את הרווח התפעולי. איזו פעולה *לא* תשפיע עליו באופן ישיר?",
                answers: [
                    { text: "הורדת עלויות הנהלה וכלליות (Opex)", correct: false, explanation: "Opex הוא רכיב מרכזי בחישוב הרווח התפעולי ולכן הורדתו תשפיע ישירות." },
                    { text: "שיפור הרווחיות הגולמית על ידי העלאת מחירים", correct: false, explanation: "שיפור הרווח הגולמי 'זורם' ישירות לשיפור הרווח התפעולי." },
                    { text: "הפחתת הוצאות המימון על ידי לקיחת הלוואה זולה יותר", correct: true, explanation: "הוצאות מימון מופיעות בדו\"ח רווח והפסד *אחרי* הרווח התפעולי. הן משפיעות על הרווח הנקי." },
                    { text: "ייעול תקציב השיווק והמכירות", correct: false, explanation: "הוצאות שיווק ומכירות הן חלק מההוצאות התפעוליות, וייעולן ישפר את הרווח התפעולי." }
                ]
            },
             {
                question: "בניתוח רווחיות ערוצים, נמצא שערוץ האונליין מציג Gross Margin % גבוה יותר מערוץ הריטייל. מה יכולה להיות הסיבה?",
                answers: [
                    { text: "בערוץ האונליין יש פחות הוצאות סחר (Trade Spend) והנחות לקמעונאים", correct: true, explanation: "מכירה ישירה לצרכן חוסכת את המרווחים וההנחות שיש לתת לרשתות הקמעונאיות, מה שמוביל ל-Net Sales גבוה יותר ולכן לרווחיות גולמית גבוהה יותר." },
                    { text: "עלות המכר (COGS) של המוצרים הנמכרים באונליין נמוכה יותר", correct: false, explanation: "בדרך כלל מדובר באותם מוצרים עם אותו COGS. ההבדל נובע ממבנה ההכנסות." },
                    { text: "הוצאות המשלוח ללקוח (Last mile delivery) נמוכות מאוד", correct: false, explanation: "הוצאות משלוח הן לרוב הוצאה תפעולית (לא בתוך ה-Gross Margin) והן יכולות להיות גבוהות למדי." },
                    { text: "בערוץ הריטייל יש יותר הוצאות פרסום", correct: false, explanation: "הוצאות פרסום הן חלק מההוצאות התפעול ואינן משפיעות על הרווח הגולמי." }
                ]
            },
            {
                question: "איזו שיטת תחזית היא המתאימה ביותר עבור מוצר חדש לחלוטין שאין לו היסטוריית מכירות?",
                answers: [
                    { text: "ממוצע נע (Moving Average)", correct: false, explanation: "שיטה זו דורשת נתונים היסטוריים." },
                    { text: "צמיחה שנתית (YoY)", correct: false, explanation: "שיטה זו דורשת נתונים היסטוריים מהשנה הקודמת." },
                    { text: "תחזית המבוססת על נתוני השוק, מחקר מתחרים, והשוואה למוצרים דומים (Look-alike)", correct: true, explanation: "בהיעדר נתונים פנימיים, יש להסתמך על מקורות חיצוניים והנחות מבוססות כדי לבנות תחזית ראשונית." },
                    { text: "Run-rate", correct: false, explanation: "Run-rate דורש נתוני מכירות עדכניים, שאינם קיימים עבור מוצר שטרם הושק." }
                ]
            },
             {
                question: "ניתוח PVM מראה: Revenue +10%, Volume +15%, Price -3%, Mix -2%. מהי המסקנה העיקרית?",
                answers: [
                    { text: "החברה העלתה מחירים בהצלחה", correct: false, explanation: "הנתונים מראים שהמחיר הממוצע ירד ב-3%." },
                    { text: "הצמיחה הגיעה ממכירת יותר מוצרים, אך במחיר נמוך יותר ובתמהיל זול יותר", correct: true, explanation: "הגידול המשמעותי ב-Volume הוא המנוע המרכזי לצמיחה, אך הוא קוזז חלקית על ידי ירידת מחיר ומעבר למוצרים זולים יותר." },
                    { text: "הלקוחות עברו לקנות מוצרי פרימיום יקרים יותר", correct: false, explanation: "אפקט ה-Mix השלילי (-2%) מראה בדיוק את ההיפך - הלקוחות קנו תמהיל מוצרים זול יותר בממוצע." },
                    { text: "החברה צמצמה הנחות לקמעונאים", correct: false, explanation: "צמצום הנחות היה מוביל לאפקט Price חיובי, לא שלילי." }
                ]
            },
            {
                question: "מהו ההבדל בין תקציב (Budget) לתחזית (Forecast)?",
                answers: [
                    { text: "אין הבדל, אלו מילים נרדפות", correct: false, explanation: "אלו שני כלים ניהוליים שונים עם מטרות שונות." },
                    { text: "התקציב נקבע פעם בשנה כיעד סטטי, בעוד התחזית מתעדכנת באופן שוטף כדי לשקף את המציאות המשתנה", correct: true, explanation: "התקציב הוא ה'מטרה' או ה'התחייבות'. התחזית היא ה'צפי' המעודכן ביותר להשגת המטרה." },
                    { text: "התקציב מתמקד בהכנסות והתחזית מתמקדת בהוצאות", correct: false, explanation: "שניהם עוסקים בכל רכיבי דו\"ח רווח והפסד." },
                    { text: "התחזית משמשת לקביעת בונוסים למנהלים, והתקציב משמש לתכנון תפעולי", correct: false, explanation: "בדרך כלל המצב הפוך: יעדי הבונוס נקבעים לפי עמידה בתקציב." }
                ]
            },
             {
                question: "מתי נכון להשתמש ב-Gross Sales במקום ב-Net Sales לצורך ניתוח?",
                answers: [
                    { text: "תמיד עדיף להשתמש ב-Gross Sales כי המספר גדול יותר", correct: false, explanation: "Net Sales משקף את ההכנסה האמיתית של החברה ולכן הוא כמעט תמיד המספר הנכון לרוב הניתוחים." },
                    { text: "בחישוב רווח גולמי", correct: false, explanation: "רווח גולמי מחושב תמיד על בסיס Net Sales." },
                    { text: "בניתוח אפקטיביות של צוות המכירות בקביעת מחיר המחירון הראשוני, לפני הנחות", correct: true, explanation: "Gross Sales יכול לשמש כמדד ליכולת של צוות המכירות למכור במחיר המחירון, לפני שההנחות והמבצעים נכנסים לתמונה." },
                    { text: "בחישוב DSO", correct: false, explanation: "DSO מחושב תמיד על בסיס Net Sales, מכיוון שזו ההכנסה שבגינה נוצר חוב הלקוח." }
                ]
            },
             {
                question: "החברה שוקלת השקעה גדולה באוטומציה במפעל. איזו שורה בדו\"ח רווח והפסד צפויה להיות המושפעת ביותר לטובה בטווח הארוך?",
                answers: [
                    { text: "Net Sales", correct: false, explanation: "אוטומציה לא משפיעה ישירות על מחיר המכירה או כמות המכירה." },
                    { text: "COGS (עלות המכר)", correct: true, explanation: "אוטומציה נועדה להפחית עלויות ייצור ישירות, בעיקר עלויות עבודה, ולכן היא תשפר את שורת ה-COGS ואת הרווח הגולמי." },
                    { text: "Trade Spend", correct: false, explanation: "אין קשר בין אוטומציה במפעל להסכמים המסחריים עם קמעונאים." },
                    { text: "הוצאות מימון", correct: false, explanation: "ההשקעה עצמה עשויה לדרוש מימון, מה שיגדיל את הוצאות המימון בטווח הקצר, אך ההשפעה החיובית המרכזית היא על ה-COGS." }
                ]
            },
            {
                question: "באיזה תרחיש עלייה ב-Inventory Turns (יחס סבב מלאי) עלולה להוות סימן שלילי?",
                answers: [
                    { text: "כאשר החברה מצליחה למכור מהר יותר בזכות מבצעים מוצלחים", correct: false, explanation: "זהו תרחיש חיובי." },
                    { text: "כאשר היחס עולה בגלל מחסור מתמשך בסחורה ואיבוד מכירות (Lost Sales)", correct: true, explanation: "במצב זה, המלאי הממוצע (המכנה) נמוך מאוד, מה ש'מנפח' את היחס באופן מלאכותי, אך הסיפור האמיתי הוא שהחברה מפסידה הכנסות כי אין לה מה למכור." },
                    { text: "כאשר החברה משפרת את תהליכי התחזית ותכנון הייצור שלה", correct: false, explanation: "זהו תרחיש חיובי המעיד על יעילות." },
                    { text: "כאשר החברה עוברת למכור מוצרים עם חיי מדף קצרים יותר", correct: false, explanation: "זהו שינוי עסקי לגיטימי שידרוש יחס סבב מלאי גבוה יותר, וזה לא בהכרח סימן שלילי." }
                ]
            }
        ];


        const startScreen = document.getElementById('start-screen');
        const gameScreen = document.getElementById('game-screen');
        const endScreen = document.getElementById('end-screen');
        
        const startBtn = document.getElementById('start-btn');
        const nextBtn = document.getElementById('next-btn');
        const restartBtn = document.getElementById('restart-btn');
        const studyPlanBtn = document.getElementById('study-plan-btn');
        const deeperExplanationBtn = document.getElementById('deeper-explanation-btn');

        const questionCounter = document.getElementById('question-counter');
        const scoreDisplay = document.getElementById('score');
        const progressBar = document.getElementById('progress-bar');
        const questionText = document.getElementById('question-text');
        const answersContainer = document.getElementById('answers-container');
        
        const feedbackContainer = document.getElementById('feedback-container');
        const feedbackText = document.getElementById('feedback-text');
        const explanationText = document.getElementById('explanation-text');
        const geminiExplanationOutput = document.getElementById('gemini-explanation-output');
        
        const finalScoreDisplay = document.getElementById('final-score');
        const geminiStudyPlanOutput = document.getElementById('gemini-study-plan-output');

        let currentQuestionIndex = 0;
        let score = 0;
        let shuffledQuestions = [];
        let incorrectlyAnsweredQuestions = [];

        startBtn.addEventListener('click', startGame);
        nextBtn.addEventListener('click', () => {
            currentQuestionIndex++;
            setNextQuestion();
        });
        restartBtn.addEventListener('click', startGame);
        deeperExplanationBtn.addEventListener('click', getDeeperExplanation);
        studyPlanBtn.addEventListener('click', getStudyPlan);


        /**
         * A generic function to call the Gemini API with exponential backoff.
         * @param {string} prompt The prompt to send to the API.
         * @param {HTMLElement} outputElement The element to display the result in.
         * @param {HTMLElement} buttonElement The button that triggered the call, to disable it.
         */
        async function callGeminiAPI(prompt, outputElement, buttonElement) {
            buttonElement.disabled = true;
            outputElement.innerHTML = '<div class="loader"></div>';
            outputElement.classList.remove('hidden');

            const apiKey = ""; // Should be empty
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
            };
            
            let retries = 3;
            let delay = 1000;
            let response;

            while (retries > 0) {
                try {
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        const result = await response.json();
                        const candidate = result.candidates?.[0];
                        if (candidate && candidate.content?.parts?.[0]?.text) {
                            // Replace newlines with <br> for HTML rendering
                            outputElement.innerHTML = candidate.content.parts[0].text.replace(/\n/g, '<br>');
                        } else {
                           outputElement.innerText = "לא הצלחנו לקבל תשובה מפורטת כרגע. נסו שוב מאוחר יותר.";
                        }
                        buttonElement.disabled = false;
                        return; // Exit the function on success
                    } else if (response.status === 429 || response.status >= 500) {
                        // Throttling or server error, so we retry
                        console.warn(`API call failed with status ${response.status}. Retrying in ${delay}ms...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        retries--;
                        delay *= 2; // Exponential backoff
                    } else {
                        // Other client-side error, don't retry
                        throw new Error(`API call failed with status ${response.status}`);
                    }
                } catch (error) {
                    console.error("Error calling Gemini API:", error);
                    retries = 0; // Stop retrying on network errors etc.
                }
            }
            
            outputElement.innerText = "אופס! משהו השתבש. אנא בדקו את חיבור האינטרנט ונסו שוב.";
            buttonElement.disabled = false;
        }

        async function getDeeperExplanation() {
            deeperExplanationBtn.classList.add('hidden'); // Hide after one click
            const questionData = shuffledQuestions[currentQuestionIndex];
            const correctAnswer = questionData.answers.find(a => a.correct);
            const basicExplanation = questionData.answers.find(a => !a.correct && a.explanation)?.explanation || "זו התשובה הנכונה.";

            const prompt = `
                You are an expert FP&A mentor preparing a candidate for a job interview at an FMCG company.
                The candidate was asked the following question:
                Question: "${questionData.question}"

                The correct answer is: "${correctAnswer.text}"
                The basic explanation provided was: "${basicExplanation}"

                Please provide a more in-depth explanation. Use a simple real-world analogy from a supermarket or consumer goods context (like selling coffee, soda, or snacks) to make the concept easier to understand. Keep the explanation concise and focused, under 100 words. Respond in Hebrew.
            `;
            callGeminiAPI(prompt, geminiExplanationOutput, deeperExplanationBtn);
        }

        async function getStudyPlan() {
            if(incorrectlyAnsweredQuestions.length === 0) {
                geminiStudyPlanOutput.innerHTML = "<strong>כל הכבוד!</strong> ענית על כל השאלות נכון. נראה שאתה מוכן היטב. המשך לרענן את החומר ולתרגל.";
                geminiStudyPlanOutput.classList.remove('hidden');
                studyPlanBtn.disabled = true;
                return;
            }

            const incorrectQuestionsText = incorrectlyAnsweredQuestions.map((q, index) => `${index + 1}. ${q.question}`).join('\n');
            const prompt = `
                You are an expert FP&A mentor preparing a candidate for a job interview at an FMCG company.
                The candidate just finished a practice quiz and answered the following questions incorrectly:
                ${incorrectQuestionsText}

                Based on these mistakes, generate a short, encouraging, and personalized study plan.
                1. Start with an encouraging sentence.
                2. Identify the top 2-3 key themes or concepts the candidate should focus on.
                3. For each theme, provide one practical tip or a mini-exercise they can do to improve their understanding.
                Keep the entire response under 150 words. Format it with clear headings or bullet points. Respond in Hebrew.
            `;
            callGeminiAPI(prompt, geminiStudyPlanOutput, studyPlanBtn);
        }


        function startGame() {
            currentQuestionIndex = 0;
            score = 0;
            incorrectlyAnsweredQuestions = [];
            shuffledQuestions = questions.sort(() => Math.random() - 0.5);
            startScreen.classList.add('hidden');
            endScreen.classList.add('hidden');
            gameScreen.classList.remove('hidden');
            scoreDisplay.innerText = `ניקוד: 0`;
            studyPlanBtn.disabled = false;
            geminiStudyPlanOutput.classList.add('hidden');
            setNextQuestion();
        }

        function setNextQuestion() {
            resetState();
            if (currentQuestionIndex < questions.length) {
                showQuestion(shuffledQuestions[currentQuestionIndex]);
            } else {
                showEndScreen();
            }
        }

        function showQuestion(questionData) {
            questionText.innerText = questionData.question;
            questionCounter.innerText = `שאלה ${currentQuestionIndex + 1}/${questions.length}`;
            progressBar.style.width = `${((currentQuestionIndex + 1) / questions.length) * 100}%`;

            questionData.answers.forEach(answer => {
                const button = document.createElement('button');
                button.innerText = answer.text;
                button.classList.add('answer-btn', 'w-full', 'p-4', 'border-2', 'border-slate-300', 'rounded-lg', 'text-slate-700', 'text-right', 'hover:bg-slate-100', 'hover:border-indigo-400', 'transition-all', 'duration-200');
                if (answer.correct) {
                    button.dataset.correct = answer.correct;
                }
                button.dataset.explanation = answer.explanation;
                button.addEventListener('click', selectAnswer);
                answersContainer.appendChild(button);
            });
        }

        function resetState() {
            nextBtn.classList.add('hidden');
            feedbackContainer.classList.add('hidden');
            deeperExplanationBtn.classList.add('hidden');
            geminiExplanationOutput.classList.add('hidden');
            feedbackContainer.classList.remove('bg-green-100', 'text-green-800', 'bg-red-100', 'text-red-800');
            explanationText.innerText = '';
            feedbackText.innerText = '';
            while (answersContainer.firstChild) {
                answersContainer.removeChild(answersContainer.firstChild);
            }
        }

        function selectAnswer(e) {
            const selectedBtn = e.target;
            const isCorrect = selectedBtn.dataset.correct === 'true';
            
            Array.from(answersContainer.children).forEach(button => {
                button.disabled = true; // Disable all buttons
                setStatusClass(button, button.dataset.correct === 'true');
            });

            feedbackContainer.classList.remove('hidden');
            deeperExplanationBtn.classList.remove('hidden');

            if (isCorrect) {
                score++;
                scoreDisplay.innerText = `ניקוד: ${score}`;
                selectedBtn.classList.add('correct');
                feedbackContainer.classList.add('bg-green-100', 'text-green-800');
                feedbackText.innerText = 'תשובה נכונה! מצוין!';
            } else {
                incorrectlyAnsweredQuestions.push(shuffledQuestions[currentQuestionIndex]);
                selectedBtn.classList.add('incorrect');
                feedbackContainer.classList.add('bg-red-100', 'text-red-800');
                feedbackText.innerText = 'תשובה לא נכונה...';
                explanationText.innerText = selectedBtn.dataset.explanation;
            }
            
            if (currentQuestionIndex < questions.length -1) {
                nextBtn.innerText = "השאלה הבאה";
                nextBtn.classList.remove('hidden');
            } else {
                 nextBtn.innerText = "סיים וצפה בתוצאות";
                 nextBtn.classList.remove('hidden');
            }
        }
        
        function setStatusClass(element, correct) {
            // Clear previous hover effects and add result styling
            element.classList.remove('hover:bg-slate-100', 'hover:border-indigo-400');
            if (correct) {
                element.classList.add('bg-green-200', 'border-green-500');
            } else {
                 element.classList.add('bg-red-200', 'border-red-500');
            }
        }

        function showEndScreen() {
             gameScreen.classList.add('hidden');
             endScreen.classList.remove('hidden');
             finalScoreDisplay.innerText = `${score} / ${questions.length}`;
        }
    </script>
</body>
</html>

