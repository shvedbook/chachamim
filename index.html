<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>שחזור מבחן: עולמם של חכמים (Canvas)</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Assistant', sans-serif;
            background-color: #f3f4f6; /* gray-100 */
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            padding: 1rem;
            box-sizing: border-box;
        }
        canvas {
            background-color: white;
            border-radius: 1.5rem; /* 24px */
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            display: block;
            max-width: 100%;
        }
    </style>
</head>
<body>

    <canvas id="gameCanvas" width="900" height="750"></canvas>

    <script>
        // --- Data ---
        // All strings are now enclosed in single quotes to avoid conflicts with internal double quotes.
        const allQuizData = [
            // ===================================
            // חוני המעגל
            // ===================================
            {
                category: 'חוני המעגל',
                question: 'מדוע, על פי המרצה, אין מתפללים על הפסקת גשמים מרובים?',
                options: ['כי גשם הוא תמיד ברכה', 'כי התפילה לא תעזור במקרה כזה', 'כי הגשם הוא מתנת חיים מאלוקים, ואין לבקש להפסיק מתנה.', 'כי זה עלול לגרום לבצורת'],
                correctAnswer: 'כי הגשם הוא מתנת חיים מאלוקים, ואין לבקש להפסיק מתנה.',
                explanation: 'לדעת המרצה, הסיבה שלא מתפללים על הפסקת גשמים היא מכיוון שהגשם נחשב למתנת חיים מאלוקים, ואין זה ראוי לבקש להפסיק מתנה כזו.'
            },
            {
                category: 'חוני המעגל',
                question: 'מה עשה חוני המעגל לאחר שתפילתו הראשונה לגשם לא נענתה?',
                options: ['הוא הקריב קורבן', 'הוא עג עוגה, נכנס לתוכה, ונשבע שלא ייצא עד שירד גשם.', 'הוא ביקש משמעון בן שטח שיתפלל', 'הוא ויתר וחזר לביתו'],
                correctAnswer: 'הוא עג עוגה, נכנס לתוכה, ונשבע שלא ייצא עד שירד גשם.',
                explanation: 'לאחר שהתפלל ולא ירד גשם, חוני עשה עיגול, נכנס אליו ונשבע בשם ה\' שלא ייצא משם עד שירד גשם.'
            },
            {
                category: 'חוני המעגל',
                question: 'על פי התלמוד, מה הייתה הביקורת המרכזית של שמעון בן שטח כלפי חוני?',
                options: ['שמעשיו עלולים להוביל לחילול השם אם הנס לא יתרחש.', 'שחוני פעל בחוצפה כלפי שמיים.', 'שחוני לא כיבד את הסנהדרין.', 'שחוני התפלל בזמן לא נכון.'],
                correctAnswer: 'שמעשיו עלולים להוביל לחילול השם אם הנס לא יתרחש.',
                explanation: 'שמעון בן שטח חשש שאם חוני היה חי בתקופת אליהו והנס לא היה מתרחש, הדבר היה מוביל לחילול השם, כפירה ואיבוד אמונה.'
            },
            {
                category: 'חוני המעגל',
                question: 'כיצד נהרג חוני המעגל לפי יוסף בן מתתיהו?',
                options: ['נרדם ומת בשנתו', 'מת מצער לאחר שלא הכירו אותו', 'נהרג בסקילה לאחר שהתפלל שה\' לא ישמע לתפילות הלוחמים.', 'הוצא להורג על ידי הרומאים'],
                correctAnswer: 'נהרג בסקילה לאחר שהתפלל שה\' לא ישמע לתפילות הלוחמים.',
                explanation: 'יוסף בן מתתיהו מספר שהורקנוס תפס את חוני וביקש שיקלל את אויביו. חוני התפלל תפילה ניטרלית, ובתגובה נהרג בסקילה.'
            },
             {
                category: 'חוני המעגל',
                question: 'מה גרם לחוני המעגל להתפלל על מותו לאחר שהתעורר משנתו בת 70 השנה?',
                options: ['שהעולם השתנה והוא לא הכיר דבר.', 'שאף אחד לא האמין לו שהוא חוני המעגל ולא נהגו בו כבוד.', 'שהוא החמיץ את בניית בית המקדש השני.', 'שהחרוב שלידו גדל מאוד.'],
                correctAnswer: 'שאף אחד לא האמין לו שהוא חוני המעגל ולא נהגו בו כבוד.',
                explanation: 'כשהתעורר, איש לא האמין לו שהוא חוני. מרוב תסכול, הוא התפלל למות, ובקשתו נענתה. הסיפור מסמל שגישתו המיסטית לא התקבלה עוד.'
            },
            // ===================================
            // הלל הזקן
            // ===================================
            {
                category: 'הלל הזקן',
                question: 'מה הכריע את הוויכוח ההלכתי בין הלל לזקני בתירה לגבי הקרבת הפסח בשבת?',
                options: ['ההיגיון החדשני של הלל', 'ההסתמכות של הלל על מסורת שקיבל מרבותיו, שמעיה ואבטליון.', 'איום בנידוי מצד הלל', 'התערבות של בת קול'],
                correctAnswer: 'ההסתמכות של הלל על מסורת שקיבל מרבותיו, שמעיה ואבטליון.',
                explanation: 'למרות שהלל הציג טיעונים לוגיים (היקש, קל וחומר), זקני בתירה לא קיבלו את דעתו עד שאמר "כך שמעתי משמעיה ואבטליון", כלומר, הסתמך על המסורת.'
            },
            {
                category: 'הלל הזקן',
                question: 'מה הייתה המוטיבציה העיקרית של הלל בתקנת ה"פרוזבול"?',
                options: ['לעקוף את דין התורה כדי להקל על העשירים.', 'לחזק את כוחו של בית הדין.', 'לסייע לעניים, מכיוון שבעלי הממון נמנעו מלהלוות להם לפני שנת השמיטה.', 'לבטל את מצוות שמיטת כספים.'],
                correctAnswer: 'לסייע לעניים, מכיוון שבעלי הממון נמנעו מלהלוות להם לפני שנת השמיטה.',
                explanation: 'הלל ראה שהחשש מביטול חובות בשמיטה גורם לעשירים להימנע מלתת הלוואות, מה שפגע בעניים. תקנת הפרוזבול נועדה "לעקוף" את דין התורה כדי לתקן את המצב ולעזור לעניים.'
            },
            {
                category: 'הלל הזקן',
                question: 'מהי "כל התורה כולה על רגל אחת" לפי הלל?',
                options: ['שמע ישראל ה\' אלוהינו ה\' אחד.', 'לא תגנוב.', 'דעלך סני לחברך לא תעביד (מה ששנוא עליך, אל תעשה לחברך).', 'פרו ורבו.'],
                correctAnswer: 'דעלך סני לחברך לא תעביד (מה ששנוא עליך, אל תעשה לחברך).',
                explanation: 'לנוכרי שביקש ללמוד את כל התורה על רגל אחת, אמר הלל: "דעלך סני לחברך לא תעביד - זו היא כל התורה כולה, ואידך - פירושה הוא, זיל גמור".'
            },
            {
                category: 'הלל הזקן',
                question: 'מדוע חיללו את השבת עבור הלל הזקן כשקפא על גג בית המדרש?',
                options: ['כי הוא היה עתיד להיות הנשיא.', 'כי מסירות נפשו לתורה הייתה ראויה לכך.', 'מדין פיקוח נפש, כי היה בסכנת חיים.', 'כי שמעיה ואבטליון הורו כך.'],
                correctAnswer: 'מדין פיקוח נפש, כי היה בסכנת חיים.',
                explanation: 'אף על פי שהסיפור מדגיש את מסירותו, הסיבה ההלכתית לחילול השבת הייתה פיקוח נפש. הם אמרו "ראוי זה לחלל עליו את השבת", מה שמרמז גם על חשיבותו וגם על סכנת החיים.'
            },
             {
                category: 'הלל הזקן',
                question: 'מה היה ההבדל העיקרי בין בית הלל לבית שמאי בקבלת תלמידים?',
                options: ['בית שמאי קיבלו רק בבליים, ובית הלל רק ירושלמים.', 'בית הלל גבו שכר לימוד נמוך יותר.', 'בית שמאי היו סלקטיביים וקיבלו רק בעלי מעמד, ובית הלל קיבלו את כולם.', 'בית שמאי לימדו בבוקר, ובית הלל בערב.'],
                correctAnswer: 'בית שמאי היו סלקטיביים וקיבלו רק בעלי מעמד, ובית הלל קיבלו את כולם.',
                explanation: 'בית שמאי היו סלקטיביים והכניסו אנשים במעמד גבוה ועשירים, בעוד בית הלל הכניסו את כולם, מתוך אמונה בפוטנציאל של כל אדם.'
            },
            // ===================================
            // נשיאים וחכמים
            // ===================================
            {
                category: 'נשיאים וחכמים',
                question: 'מה הייתה הסיבה המרכזית למחלוקת החוזרת בין רבן גמליאל לרבי יהושע?',
                options: ['מחלוקת על כסף', 'מחלוקת על סמכות הנשיא ובית הדין לקבוע הלכה, גם כשהם טועים.', 'יריבות אישית', 'ויכוח על פרשנות התורה'],
                correctAnswer: 'מחלוקת על סמכות הנשיא ובית הדין לקבוע הלכה, גם כשהם טועים.',
                explanation: 'הוויכוחים, כמו זה על קידוש החודש, נסובו סביב שאלת הסמכות. רבן גמליאל דרש ציות מוחלט כדי למנוע מחלוקות, גם אם טעה, ואילו רבי יהושע התקשה לקבל טעות.'
            },
            {
                category: 'נשיאים וחכמים',
                question: 'מה היה השינוי המיידי בבית המדרש לאחר הדחת רבן גמליאל ומינוי רבי אלעזר בן עזריה?',
                options: ['החלו ללמד ביוונית', 'הוסיפו ספסלים ופתחו את הדלתות לכל מי שרצה ללמוד.', 'קיצרו את יום הלימודים', 'העלו את שכר הלימוד'],
                correctAnswer: 'הוסיפו ספסלים ופתחו את הדלתות לכל מי שרצה ללמוד.',
                explanation: 'המינוי של רבי אלעזר בן עזריה סימל שינוי מהגישה האריסטוקרטית של רבן גמליאל לגישה הפתוחה של הלל. מיד סולק שומר הפתח וניתנה רשות לכולם להיכנס.'
            },
             {
                category: 'נשיאים וחכמים',
                question: 'מה הייתה התוכנית של רבי מאיר ורבי נתן להדיח את רבן שמעון בן גמליאל (רשב"ג)?',
                options: ['להתווכח איתו על הלכה בפומבי.', 'להוכיח שהוא אינו בקיא במסכת עוקצין ובכך לערער על סמכותו.', 'לדווח עליו לשלטון הרומאי.', 'לגרום לעם למרוד בו.'],
                correctAnswer: 'להוכיח שהוא אינו בקיא במסכת עוקצין ובכך לערער על סמכותו.',
                explanation: 'לאחר שרשב"ג שינה את דירוג הכבוד, רבי מאיר ורבי נתן רצו לנקום בו. הם תכננו לבקש ממנו לדרוש במסכת עוקצין, בידיעה שאינו בקיא בה, ובכך להוכיח שהם חכמים ממנו ולהדיחו.'
            },
             {
                category: 'נשיאים וחכמים',
                question: 'מה גרם לרבי יהודה הנשיא לשנות את דעתו ולהאכיל את כולם בשנת הבצורת, ולא רק תלמידי חכמים?',
                options: ['הוא הבין שאין מספיק תלמידי חכמים.', 'הביקורת של רבי יונתן בן עמרם, שביקש להתפרנס "ככלב וכעורב".', 'בנו שכנע אותו.', 'נגמר האוכל המיוחד לחכמים.'],
                correctAnswer: 'הביקורת של רבי יונתן בן עמרם, שביקש להתפרנס "ככלב וכעורב".',
                explanation: 'בתחילה חילק רבי יהודה הנשיא אוכל רק לבעלי השכלה. רבי יונתן בן עמרם נדחק פנימה וביקש שיפרנס אותו "ככלב וכעורב" (שה\' דואג להם). דבריו גרמו לרבי לשנות את דעתו ולהכריז: "יכנסו הכל".'
            },
             {
                category: 'נשיאים וחכמים',
                question: 'מה גרם לסיום ייסוריו הקשים של רבי יהודה הנשיא?',
                options: ['הוא התפלל לה\'.', 'הוא עשה תשובה ולמד לרחם על הבריות, כפי שבא לידי ביטוי כשרחם על בני חולדה.', 'הוא חילק צדקה.', 'הוא סיים לכתוב את המשנה.'],
                correctAnswer: 'הוא עשה תשובה ולמד לרחם על הבריות, כפי שבא לידי ביטוי כשרחם על בני חולדה.',
                explanation: 'ייסוריו של רבי החלו לאחר שאמר לעגל "לך, לכך נוצרת". הם הסתיימו רק כשהפגין רחמים כלפי בני חולדה ואמר "ורחמיו על כל מעשיו כתוב".'
            },
             // ===================================
            // עולם בית המדרש
            // ===================================
            {
                category: 'עולם בית המדרש',
                question: 'בסיפור על אילפא ורבי יוחנן, מדוע רצו המלאכים להרוג אותם?',
                options: ['כי הם ישבו תחת כותל רעוע.', 'כי הם החליטו לעזוב את לימוד התורה ("חיי עולם") לטובת פרנסה ("חיי שעה").', 'כי הם היו עניים.', 'כי הם התווכחו ביניהם.'],
                correctAnswer: 'כי הם החליטו לעזוב את לימוד התורה ("חיי עולם") לטובת פרנסה ("חיי שעה").',
                explanation: 'כאשר אילפא ורבי יוחנן שקלו לעזוב את הישיבה לטובת עסקים, שמעו מלאכים שאמרו "שמניחין חיי עולם ועוסקין בחיי שעה!" ורצו להפיל עליהם את הכותל.'
            },
            {
                category: 'עולם בית המדרש',
                question: 'מה גרם לקרע הסופי בין רבי יוחנן לריש לקיש?',
                options: ['מחלוקת על רכוש.', 'ריש לקיש רצה לחזור להיות שודד.', 'רבי יוחנן לעג לעברו של ריש לקיש כשודד, מה שגרם לריש לקיש להרגיש שאינו מוערך.', 'אחותו של רבי יוחנן התלוננה עליו.'],
                correctAnswer: 'רבי יוחנן לעג לעברו של ריש לקיש כשודד, מה שגרם לריש לקיש להרגיש שאינו מוערך.',
                explanation: 'במהלך מחלוקת הלכתית, רבי יוחנן אמר לריש לקיש: "ליסטים בליסטיותו ידע" (שודד מבין במקצועו). ריש לקיש נפגע עמוקות מההערה על עברו, מה שהוביל למחלתו ולמותו.'
            },
            {
                category: 'עולם בית המדרש',
                question: 'מה חסר לרבי יוחנן בלימוד לאחר מותו של ריש לקיש?',
                options: ['תלמיד שמסכים איתו תמיד.', 'בר-פלוגתא (חבר ללימוד) שיאתגר אותו בקושיות ויחדד את ההלכה.', 'תלמיד עשיר שיתמוך בו.', 'מישהו שיספר לו בדיחות.'],
                correctAnswer: 'בר-פלוגתא (חבר ללימוד) שיאתגר אותו בקושיות ויחדד את ההלכה.',
                explanation: 'לאחר מותו של ריש לקיש, החכמים הביאו את ר\' אלעזר בן פדת, שהיה מסכים עם כל דבריו. רבי יוחנן התגעגע לריש לקיש שהיה מקשה עליו קושיות רבות, ומתוך כך ההלכה הייתה מתבררת ומתחדדת.'
            },
            {
                category: 'עולם בית המדרש',
                question: 'מדוע עזבו רבי עקיבא ותלמידיו את מקומם תחת עץ התאנה?',
                options: ['כי בעל העץ גירש אותם.', 'כי לא היה צל.', 'הם חששו שבעל העץ חושד בהם בגניבת תאנים.', 'התאנים היו רקובות.'],
                correctAnswer: 'הם חששו שבעל העץ חושד בהם בגניבת תאנים.',
                explanation: 'רבי עקיבא ותלמידיו ראו שבעל העץ מגיע מדי יום ללקט תאנים וחששו שהוא חושד בהם בגניבה, ולכן החליטו לעבור למקום אחר.'
            },
             // ===================================
            // שכר ועונש (רשב"י)
            // ===================================
            {
                category: 'שכר ועונש (רשב"י)',
                question: 'מהי הסיבה שבגללה נידון רבי שמעון בר יוחאי (רשב"י) למוות?',
                options: ['הוא סירב לשלם מיסים.', 'הוא גינה את מעשי הרומאים וטען שהם נעשים מתוך אינטרס אישי בלבד.', 'הוא התנגד לשלטון הרומאי באופן פעיל.', 'הוא הרג חייל רומאי.'],
                correctAnswer: 'הוא גינה את מעשי הרומאים וטען שהם נעשים מתוך אינטרס אישי בלבד.',
                explanation: 'בעוד רבי יהודה שיבח את הרומאים על בניית שווקים וגשרים, רשב"י ביקר אותם בחריפות ואמר: "כל מה שתקנו - לא תקנו אלא לצורך עצמן". דבריו הגיעו לשלטון, והוא נידון למוות.'
            },
            {
                category: 'שכר ועונש (רשב"י)',
                question: 'מדוע יצאה בת קול וקראה לרשב"י ובנו לחזור למערה לאחר 12 שנים?',
                options: ['כי הרומאים עדיין חיפשו אותם.', 'כדי שימשיכו ללמוד תורה.', 'כי הם היו ביקורתיים כלפי אנשי המעשה ושרפו אותם במבטם.', 'כי הם לא הודו על הנס.'],
                correctAnswer: 'כי הם היו ביקורתיים כלפי אנשי המעשה ושרפו אותם במבטם.',
                explanation: 'כשיצאו מהמערה, הם ראו אנשים עובדים בשדה וכעסו: "מניחין חיי עולם ועוסקין בחיי שעה!". כל מקום שהביטו בו נשרף. בת קול נזפה בהם: "להחריב עולמי יצאתם? חזרו למערתכם!".'
            },
            {
                category: 'שכר ועונש (רשב"י)',
                question: 'מה גרם לרשב"י ובנו להירגע ולהתפייס עם העולם החיצון?',
                options: ['הם ראו את יופיו של הטבע.', 'הם ראו את אהבתם של ישראל למצוות, במעשה הזקן עם ההדסים לשבת.', 'הם היו עייפים מהמערה.', 'מפגש עם חתנו, רבי פנחס בן יאיר.'],
                correctAnswer: 'הם ראו את אהבתם של ישראל למצוות, במעשה הזקן עם ההדסים לשבת.',
                explanation: 'המפגש עם הזקן שרץ עם שני הדסים לכבוד שבת ("אחד כנגד \'זכור\' ואחד כנגד \'שמור\'") ריגש אותם. רשב"י אמר לבנו: "ראה כמה חביבות מצוות על ישראל", ודעתם נתיישבה עליהם.'
            },
             // ===================================
            // שמרנות וחידוש
            // ===================================
            {
                category: 'שמרנות וחידוש',
                question: 'בסיפור "תנורו של עכנאי", מהי משמעות קריאתו של רבי יהושע, "לא בשמים היא"?',
                options: ['שהתורה אינה רלוונטית עוד.', 'שהשמיים טועים בפסיקתם.', 'שאין להסתמך על ניסים או בת קול בפסיקת הלכה, כי הסמכות ניתנה לחכמים.', 'שהוא לא מאמין בניסים.'],
                correctAnswer: 'שאין להסתמך על ניסים או בת קול בפסיקת הלכה, כי הסמכות ניתנה לחכמים.',
                explanation: 'למרות שבת קול יצאה והכריזה שהלכה כרבי אליעזר, עמד רבי יהושע ואמר "לא בשמים היא". כלומר, מרגע שהתורה ניתנה בסיני, ההכרעה ההלכתית מסורה לרוב דעות של החכמים על פני האדמה, ולא להתערבות שמיימית.'
            },
            {
                category: 'שמרנות וחידוש',
                question: 'מה הייתה תגובת הקב"ה, לפי אליהו הנביא, להכרעת החכמים בסיפור "תנורו של עכנאי"?',
                options: ['הוא כעס על החכמים.', 'הוא העניש את רבי יהושע.', 'הוא שמח ו"צחק", באומרו: "ניצחוני בני, ניצחוני בני".', 'הוא החליט לא להתערב יותר בפסיקות.'],
                correctAnswer: 'הוא שמח ו"צחק", באומרו: "ניצחוני בני, ניצחוני בני".',
                explanation: 'רבי נתן שאל את אליהו הנביא מה עשה הקב"ה באותה שעה. אליהו השיב שהקב"ה חייך ואמר: "ניצחוני בני, ניצחוני בני", כלומר הוא אישר ושמח על כך שהחכמים לקחו אחריות על עולם ההלכה.'
            },
             {
                category: 'שמרנות וחידוש',
                question: 'איזו גישה קיצונית ביותר מוצגת במקורות לגבי מקורה של התורה שבעל פה?',
                options: ['שה\' לימד את משה רק כללים ועקרונות.', 'שכל חלקי התורה, כולל מה שתלמיד עתיד לחדש, נאמרו למשה בסיני.', 'שהתורה שבעל פה היא המצאה מאוחרת של החכמים.', 'שעזרא הסופר המציא את התורה שבעל פה.'],
                correctAnswer: 'שכל חלקי התורה, כולל מה שתלמיד עתיד לחדש, נאמרו למשה בסיני.',
                explanation: 'הגישה הרדיקלית ביותר היא זו של רבי יהושע בן לוי, שטוען שכל חלקי התורה, כולל מקרא, משנה, תלמוד ואפילו מה שתלמיד ותיק עתיד לחדש בפני רבו - הכול כבר נאמר למשה בסיני.'
            },
            // ===================================
            // חנוכה
            // ===================================
             {
                category: 'חנוכה',
                question: 'מהי הסיבה המרכזית לחגיגת חנוכה לפי התלמוד הבבלי (מסכת שבת)?',
                options: ['הניצחון הצבאי של המכבים.', 'הטלת המורא על היוונים.', 'נס פך השמן שהספיק לשמונה ימים.', 'השלמת חגיגות חג הסוכות.'],
                correctAnswer: 'נס פך השמן שהספיק לשמונה ימים.',
                explanation: 'התלמוד הבבלי מתמקד בנס פך השמן: "שכשנכנסו יוונים להיכל... לא מצאו אלא פך אחד של שמן... שהיה בו להדליק יום אחד. נעשה בו נס והדליקו ממנו שמונה ימים".'
            },
            // ===================================
            // זיהוי דמויות
            // ===================================
            {
                category: 'זיהוי דמויות',
                question: 'מי אמר לחוני המעגל: "אלמלא חוני אתה, גוזרני עליך נידוי"?',
                options: ['שמעון בן שטח', 'רבי יהודה הנשיא', 'הלל הזקן', 'שמאי'],
                correctAnswer: 'שמעון בן שטח',
                explanation: 'שמעון בן שטח, נשיא הסנהדרין, הוא זה שביקר את התנהגותו המתחטאת של חוני, אך נמנע מלנדות אותו בשל מעמדו המיוחד בפני המקום.'
            },
            {
                category: 'זיהוי דמויות',
                question: 'מי ההיסטוריון שתיאר את מותו של חוני המעגל בסקילה, לאחר שסירב לקלל את אחד הצדדים במלחמת האחים?',
                options: ['יוספוס פלביוס', 'טקיטוס', 'רש"י', 'רבן גמליאל'],
                correctAnswer: 'יוספוס פלביוס',
                explanation: 'יוספוס פלביוס, בספרו "קדמוניות היהודים", מביא גרסה שונה למותו של חוני, הקושרת אותו למלחמת האחים בין הורקנוס לאריסטובולוס.'
            },
            {
                category: 'זיהוי דמויות',
                question: 'מי החכם שעצר את קירות בית המדרש הנוטים ליפול באומרו: "אם תלמידי חכמים מנצחים זה את זה בהלכה - אתם מה טיבכם!"?',
                options: ['רבי יהושע', 'רבי אליעזר', 'רבי עקיבא', 'רבן גמליאל'],
                correctAnswer: 'רבי יהושע',
                explanation: 'בסיפור תנורו של עכנאי, לאחר שרבי אליעזר גרם לקירות לנטות, היה זה רבי יהושע שגער בהם ועצר אותם מליפול.'
            },
            {
                category: 'זיהוי דמויות',
                question: 'מי הלך להודיע לרבי אליעזר על נידויו, ועשה זאת בעדינות כדי לא "להחריב את העולם"?',
                options: ['רבי עקיבא', 'רבי יהושע', 'רבן גמליאל', 'אימא שלום'],
                correctAnswer: 'רבי עקיבא',
                explanation: 'רבי עקיבא, שהבין את גודל צערו של רבי אליעזר, לבש שחורים וישב בריחוק כדי לבשר לו את הבשורה הקשה בצורה מכבדת.'
            },
            {
                category: 'זיהוי דמויות',
                question: 'מי הייתה אשתו של רבי אליעזר ואחותו של רבן גמליאל, שניסתה למנוע מבעלה להתפלל כדי שאחיה לא ייענש וימות?',
                options: ['אימא שלום', 'רחל', 'ברוריה', 'יוכבד'],
                correctAnswer: 'אימא שלום',
                explanation: 'אימא שלום, אשתו של רבי אליעזר, חששה שכוח תפילתו של בעלה הפגוע יגרום למות אחיה, רבן גמליאל, שהיה ממובילי הנידוי.'
            },
            {
                category: 'זיהוי דמויות',
                question: 'מי היו שני רבותיו של הלל הזקן, שאת דבריהם שמע במסירות נפש דרך ארובת בית המדרש?',
                options: ['שמעיה ואבטליון', 'רבי עקיבא ורבי ישמעאל', 'בית שמאי ובית הלל', 'משה ויהושע'],
                correctAnswer: 'שמעיה ואבטליון',
                explanation: 'הלל למד תורה משמעיה ואבטליון, ראשי הסנהדרין שקדמו לו, והסתמך על המסורת שקיבל מהם בוויכוחו עם זקני בתירה.'
            },
            {
                category: 'זיהוי דמויות',
                question: 'מי היה המצביא הרומי שהעניק לרבי יוחנן בן זכאי את בקשתו "תן לי יבנה וחכמיה"?',
                options: ['אספסיאנוס', 'טיטוס', 'נירון', 'אדריאנוס'],
                correctAnswer: 'אספסיאנוס',
                explanation: 'לפני שהפך לקיסר, אספסיאנוס היה המצביא שצר על ירושלים. רבי יוחנן בן זכאי ניבא לו את עלייתו לשלטון ובתמורה קיבל את בקשותיו.'
            },
            {
                category: 'זיהוי דמויות',
                question: 'מי היה ראש הבריונים בירושלים ואחיינו של ריב"ז, שעזר לדודו לצאת מהעיר הנצורה בארון מתים?',
                options: ['אבא סיקרא', 'בר גיורא', 'אלעזר בן שמעון', 'יוחנן מגוש חלב'],
                correctAnswer: 'אבא סיקרא',
                explanation: 'אבא סיקרא היה ראש הסיקריים, קבוצת קנאים בירושלים. למרות עמדותיו הקיצוניות, הוא כיבד את דודו, רבי יוחנן בן זכאי, וסייע לו בבריחתו.'
            },
            {
                category: 'זיהוי דמויות',
                question: 'מי מונה לנשיא במקום רבן גמליאל לאחר שהודח, והיה ידוע כחכם, עשיר ומיוחס (עשירי לעזרא)?',
                options: ['רבי אלעזר בן עזריה', 'רבי יהושע', 'רבי עקיבא', 'רבי מאיר'],
                correctAnswer: 'רבי אלעזר בן עזריה',
                explanation: 'לאחר שהחכמים החליטו להדיח את רבן גמליאל, הם חיפשו מחליף ראוי ומצאו את רבי אלעזר בן עזריה שהיה בעל כל המעלות הנדרשות.'
            },
            {
                category: 'זיהוי דמויות',
                question: 'מי היה המתורגמן בבית המדרש, שהחכמים הורו לו להפסיק לתרגם כאשר רבן גמליאל השפיל את רבי יהושע?',
                options: ['חוצפית', 'אונקלוס', 'יונתן בן עוזיאל', 'שמעון הפקולי'],
                correctAnswer: 'חוצפית',
                explanation: 'חוצפית המתורגמן שימש כ"רמקול" של הדרשן. כשהשפלתו של רבי יהושע הפכה לבלתי נסבלת, העם מחה והורה לחוצפית לשתוק.'
            },
            {
                category: 'זיהוי דמויות',
                question: 'מי היו שני החכמים שתכננו להכשיל את רשב"ג בשאלה במסכת עוקצין כדי להדיחו מהנשיאות?',
                options: ['רבי מאיר ורבי נתן', 'רבי יהושע ורבי עקיבא', 'רבי אליעזר ורבי טרפון', 'הלל ושמאי'],
                correctAnswer: 'רבי מאיר ורבי נתן',
                explanation: 'לאחר שרשב"ג פגע בכבודם, רבי מאיר (החכם) ורבי נתן (אב בית הדין) תכננו להביך אותו בפומבי כדי להדיחו מתפקידו.'
            },
            {
                category: 'זיהוי דמויות',
                question: 'מי הזהיר את רשב"ג מפני מזימתם של רבי מאיר ורבי נתן, בכך שלמד מסכת עוקצין בקול רם מחוץ לחלונו?',
                options: ['יעקב בן קרשי', 'רבי יוסי', 'אלישע בן אבויה', 'רבי חנינא בן דוסא'],
                correctAnswer: 'יעקב בן קרשי',
                explanation: 'יעקב בן קרשי שמע את המזימה, ולא רצה להלשין ישירות. לכן, הוא רמז לרשב"ג על המתרחש באמצעות לימוד המסכת הספציפית בקול.'
            },
            {
                category: 'זיהוי דמויות',
                question: 'מי היה בנו של רשב"ג, ששאלתו על הכינוי "אחרים" הביאה לפיוס ולסיום המאבק הבין-דורי בבית המדרש?',
                options: ['רבי יהודה הנשיא', 'רבי שמעון', 'רבן גמליאל', 'הלל'],
                correctAnswer: 'רבי יהודה הנשיא',
                explanation: 'בנו של רשב"ג, רבי יהודה הנשיא (שכונה בצעירותו "רבי"), שאל את אביו על פשר הכינויים האנונימיים, מה שגרם לרשב"ג להבין את טעותו ולהתפייס.'
            },
            {
                category: 'זיהוי דמויות',
                question: 'מי היה ראש הגולה בבבל, שרבי יהודה הנשיא העריכו כל כך עד שהצהיר שאם יגיע לארץ, יוותר למענו על הנשיאות?',
                options: ['רב הונא', 'רב אשי', 'רבינא', 'אביי'],
                correctAnswer: 'רב הונא',
                explanation: 'כביטוי לענוותנותו, רבי יהודה הנשיא הצהיר שרק אדם אחד עולה עליו בחשיבותו - רב הונא, ראש הגולה בבבל.'
            },
            {
                category: 'זיהוי דמויות',
                question: 'מי היה החבר שלמד עם רבי יוחנן, עזב לעסקים, הצליח, וכשחזר הוכיח את למדנותו כשתלה עצמו על תורן ספינה?',
                options: ['אילפא', 'רבי יוחנן', 'רבי אבהו', 'רבי זירא'],
                correctAnswer: 'אילפא',
                explanation: 'אילפא בחר ב"חיי שעה" (עסקים) בעוד חברו רבי יוחנן נשאר ב"חיי עולם" (לימוד תורה). למרות הצלחתו החומרית, אילפא רצה להוכיח שלא איבד את למדנותו.'
            },
            {
                category: 'זיהוי דמויות',
                question: 'מי היה ראש שודדים שפגש את רבי יוחנן בירדן, חזר בתשובה והפך לבר-הפלוגתא הגדול שלו?',
                options: ['ריש לקיש', 'בר כוכבא', 'אבא סיקרא', 'זמרי בן סלוא'],
                correctAnswer: 'ריש לקיש',
                explanation: 'שמעון בן לקיש, המכונה ריש לקיש, היה ראש שודדים. המפגש עם רבי יוחנן שינה את חייו והוא הפך לאחד מגדולי האמוראים.'
            },
            {
                category: 'זיהוי דמויות',
                question: 'מי נשלח ללמוד עם רבי יוחנן לאחר מות ריש לקיש, אך במקום להקשות קושיות, רק הסכים עם כל דבריו?',
                options: ['רבי אלעזר בן פדת', 'רבי אמי', 'רבי אסי', 'רבי חייא'],
                correctAnswer: 'רבי אלעזר בן פדת',
                explanation: 'רבי יוחנן התאבל על ריש לקיש, שהיה מאתגר אותו. רבי אלעזר בן פדת, שהובא במקומו, רק הסכים עמו ("תניא דמסייע לך"), מה שהעמיק את צערו של רבי יוחנן.'
            },
            {
                category: 'זיהוי דמויות',
                question: 'מי בחר להתבודד במערה 3 ימים כדי להבין הלכה, וכשחזר ננזף על כך שלא למד בחברותא?',
                options: ['יהודה איש חוצי', 'חוני המעגל', 'רבי שמעון בר יוחאי', 'רבי נחמן'],
                correctAnswer: 'יהודה איש חוצי',
                explanation: 'יהודה איש חוצי העדיף לימוד אישי ומתבודד, אך רבי יוסי בר חלפתא ביקר אותו על כך, והדגיש את חשיבות הלימוד המשותף והדיון בחברותא.'
            },
            {
                category: 'זיהוי דמויות',
                question: 'מי היה החכם שהסתתר במערה עם בנו במשך 12 שנים מפני גזירת המלכות הרומית?',
                options: ['רבי שמעון בר יוחאי', 'רבי עקיבא', 'רבי חנינא בן תרדיון', 'רבי אליעזר'],
                correctAnswer: 'רבי שמעון בר יוחאי',
                explanation: 'לאחר שגינה את הרומאים ונידון למוות, רשב"י ברח עם בנו, רבי אלעזר, והסתתר במערה.'
            },
            {
                category: 'זיהוי דמויות',
                question: 'מי היה בנו של רשב"י, שלאחר היציאה מהמערה עדיין החזיק בגישה קנאית ושרף איכרים במבטו?',
                options: ['רבי אלעזר', 'רבי יהודה', 'רבי יוסי', 'רבי שמעון'],
                correctAnswer: 'רבי אלעזר',
                explanation: 'בנו של רשב"י, רבי אלעזר, היה קנאי יותר מאביו. גם לאחר היציאה השנייה מהמערה, הוא המשיך לשרוף במבטו, בעוד אביו ריפא ותיקן.'
            },
            {
                category: 'זיהוי דמויות',
                question: 'מי בישר לרשב"י ולבנו במערה שמת הקיסר ובטלה הגזירה?',
                options: ['אליהו הנביא', 'מלאך גבריאל', 'משה רבנו', 'רבי פנחס בן יאיר'],
                correctAnswer: 'אליהו הנביא',
                explanation: 'אליהו הנביא, דמות שמיימית המופיעה בסיפורים רבים, הוא זה שעמד בפתח המערה ובישר להם שהם יכולים לצאת לחופשי.'
            },
            {
                category: 'זיהוי דמויות',
                question: 'מי היה חתנו של רשב"י, שיצא לקראתו, בכה למראה גופו הפצוע, ונרפא על ידו?',
                options: ['רבי פנחס בן יאיר', 'רבי מאיר', 'רבי יהודה הנשיא', 'אלישע בן אבויה'],
                correctAnswer: 'רבי פנחס בן יאיר',
                explanation: 'רבי פנחס בן יאיר, שהיה צדיק גדול בפני עצמו, היה חתנו של רשב"י. המפגש ביניהם בבית המרחץ מסמל את חזרתו של רשב"י לחברה.'
            },
            {
                category: 'זיהוי דמויות',
                question: 'מי הלשין לשלטונות על דברי החכמים נגד הרומאים, ובסוף הסיפור רשב"י הפך אותו ל"גל של עצמות"?',
                options: ['יהודה בן גרים', 'שמעון בן שטח', 'אבא סיקרא', 'פפוס בן יהודה'],
                correctAnswer: 'יהודה בן גרים',
                explanation: 'יהודה בן גרים, שהיה תלמידם, סיפר לשלטונות את דברי רשב"י. לאחר שרשב"י יצא מהמערה, הוא ראה אותו ובעוצמת מבטו הפך אותו לגל עצמות.'
            },
            {
                category: 'זיהוי דמויות',
                question: 'מי היה רועה צאן שהתקדש לרחל, בתו של אדונו העשיר, והלך ללמוד תורה 24 שנים?',
                options: ['רבי עקיבא', 'הלל הזקן', 'רבי שמעון בר יוחאי', 'רבי אליעזר'],
                correctAnswer: 'רבי עקיבא',
                explanation: 'רבי עקיבא היה רועה צאן פשוט אצל בן כלבא שבוע. בתו, רחל, זיהתה את הפוטנציאל שבו ונישאה לו בסתר בתנאי שילך ללמוד תורה.'
            },
            {
                category: 'זיהוי דמויות',
                question: 'מי היה המושל הרומי שגזר על רבי עקיבא מיתה בעינויים וסרק את בשרו במסרקות ברזל?',
                options: ['טורנוסרופוס', 'אספסיאנוס', 'אדריאנוס', 'טיטוס'],
                correctAnswer: 'טורנוסרופוס',
                explanation: 'טורנוסרופוס הרשע היה המושל הרומי שהיה אחראי לעינויו והריגתו של רבי עקיבא, אחד מ"עשרת הרוגי מלכות".'
            }
        ];

        // --- Canvas & Context Setup ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        // --- Game State & Caching ---
        const SAVE_KEY = 'sagesQuizGameState';
        const GameState = {
            MENU: 'menu',
            QUIZ: 'quiz',
            END_SCREEN: 'end_screen'
        };
        let currentGameState = GameState.MENU;
        let currentQuiz = [];
        let incorrectQuestions = [];
        let currentQuestionIndex = 0;
        let score = 0;
        let currentCategory = 'All';
        let isReviewMode = false;
        let answerSelected = false;
        let selectedAnswer = null;
        let isCorrect = false;
        
        // --- UI State ---
        let clickableAreas = [];
        let mousePos = { x: 0, y: 0 };
        let currentHover = null;

        // --- Styling Constants ---
        const COLORS = {
            background: '#FFFFFF',
            text: '#1f2937',
            lightText: '#4b5563',
            primary: '#4f46e5',
            green: '#22c55e',
            red: '#ef4444',
            orange: '#f97316',
            gray: '#6b7280',
            lightGray: '#f3f4f6',
            border: '#e5e7eb',
            explanationBg: '#eef2ff',
            shadow: 'rgba(0,0,0,0.1)'
        };

        // --- Caching Functions ---
        function saveState() {
            try {
                const state = {
                    currentGameState,
                    currentQuiz,
                    incorrectQuestions,
                    currentQuestionIndex,
                    score,
                    currentCategory,
                    isReviewMode,
                    answerSelected,
                    selectedAnswer,
                    isCorrect
                };
                localStorage.setItem(SAVE_KEY, JSON.stringify(state));
            } catch (e) {
                console.error("Could not save game state:", e);
            }
        }

        function loadState() {
            try {
                const savedState = localStorage.getItem(SAVE_KEY);
                if (savedState) {
                    const state = JSON.parse(savedState);
                    currentGameState = state.currentGameState || GameState.MENU;
                    currentQuiz = state.currentQuiz || [];
                    incorrectQuestions = state.incorrectQuestions || [];
                    currentQuestionIndex = state.currentQuestionIndex || 0;
                    score = state.score || 0;
                    currentCategory = state.currentCategory || 'All';
                    isReviewMode = state.isReviewMode || false;
                    answerSelected = state.answerSelected || false;
                    selectedAnswer = state.selectedAnswer || null;
                    isCorrect = state.isCorrect || false;
                    return true;
                }
            } catch (e) {
                console.error("Could not load game state:", e);
                clearStateAndRestart();
            }
            return false;
        }

        function clearStateAndRestart() {
            localStorage.removeItem(SAVE_KEY);
            // Reset all state variables to their initial values
            currentGameState = GameState.MENU;
            currentQuiz = [];
            incorrectQuestions = [];
            currentQuestionIndex = 0;
            score = 0;
            currentCategory = 'All';
            isReviewMode = false;
            answerSelected = false;
            selectedAnswer = null;
            isCorrect = false;
        }


        // --- Main Game Loop ---
        function gameLoop() {
            // Clear canvas
            ctx.fillStyle = COLORS.background;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Reset hover state for this frame
            currentHover = null;
            clickableAreas.forEach(area => {
                if (isPointInRect(mousePos.x, mousePos.y, area)) {
                    currentHover = area.id;
                }
            });
            canvas.style.cursor = currentHover ? 'pointer' : 'default';

            // Draw current screen
            switch (currentGameState) {
                case GameState.MENU:
                    drawMenuScreen();
                    break;
                case GameState.QUIZ:
                    drawQuizScreen();
                    break;
                case GameState.END_SCREEN:
                    drawEndScreen();
                    break;
            }

            requestAnimationFrame(gameLoop);
        }

        // --- Drawing Functions ---
        
        function drawRoundedRect(x, y, width, height, radius, color, shadow = false) {
            ctx.fillStyle = color;
            if (shadow) {
                ctx.shadowColor = COLORS.shadow;
                ctx.shadowBlur = 10;
                ctx.shadowOffsetY = 4;
            }
            ctx.beginPath();
            ctx.moveTo(x + radius, y);
            ctx.lineTo(x + width - radius, y);
            ctx.quadraticCurveTo(x + width, y, x + width, y + radius);
            ctx.lineTo(x + width, y + height - radius);
            ctx.quadraticCurveTo(x + width, y + height, x + width - radius, y + height);
            ctx.lineTo(x + radius, y + height);
            ctx.quadraticCurveTo(x, y + height, x, y + height - radius);
            ctx.lineTo(x, y + radius);
            ctx.quadraticCurveTo(x, y, x + radius, y);
            ctx.closePath();
            ctx.fill();
            // Reset shadow
            ctx.shadowColor = 'transparent';
            ctx.shadowBlur = 0;
            ctx.shadowOffsetY = 0;
        }

        function drawText(text, x, y, font, color, align = 'center', baseline = 'middle') {
            ctx.fillStyle = color;
            ctx.font = font;
            ctx.textAlign = align;
            ctx.textBaseline = baseline;
            ctx.fillText(text, x, y);
        }
        
        function wrapText(text, x, y, maxWidth, lineHeight, font, color) {
            ctx.font = font;
            ctx.fillStyle = color;
            ctx.textAlign = 'right';
            ctx.textBaseline = 'top';

            let words = text.split(' ');
            let line = '';
            let currentY = y;
            let lines = 1;

            for (let n = 0; n < words.length; n++) {
                let testLine = line + words[n] + ' ';
                let metrics = ctx.measureText(testLine);
                let testWidth = metrics.width;
                if (testWidth > maxWidth && n > 0) {
                    ctx.fillText(line, x, currentY);
                    line = words[n] + ' ';
                    currentY += lineHeight;
                    lines++;
                } else {
                    line = testLine;
                }
            }
            ctx.fillText(line, x, currentY);
            return {endY: currentY + lineHeight, lines: lines}; // Return the Y position after the last line
        }

        function drawMenuScreen() {
            clickableAreas = [];
            
            // Title
            drawText('מבחן: עולמם של חכמים', canvas.width / 2, 80, 'bold 40px Assistant', COLORS.text);
            drawText('בחר נושא לתרגול או התחל מבחן על כל החומר.', canvas.width / 2, 130, '20px Assistant', COLORS.lightText);

            // Category buttons
            const categories = [...new Set(allQuizData.map(q => q.category))];
            const btnWidth = 250;
            const btnHeight = 60;
            const gap = 20;
            const columns = 3;
            const startX = (canvas.width - (columns * btnWidth + (columns - 1) * gap)) / 2;
            let currentX = startX;
            let currentY = 200;

            categories.forEach((category, index) => {
                const btnId = `cat_${index}`;
                const isHovered = currentHover === btnId;
                const rect = { x: currentX, y: currentY, width: btnWidth, height: btnHeight };
                drawRoundedRect(rect.x, rect.y, rect.width, rect.height, 12, isHovered ? '#3b82f6' : COLORS.primary, true);
                drawText(category, rect.x + rect.width / 2, rect.y + rect.height / 2, 'bold 20px Assistant', '#FFFFFF');
                clickableAreas.push({ ...rect, id: btnId, onClick: () => startQuiz(category) });

                currentX += btnWidth + gap;
                if ((index + 1) % columns === 0) {
                    currentX = startX;
                    currentY += btnHeight + gap;
                }
            });
            
            // "Start All" button
            const allBtnRect = { x: startX, y: currentY + 80, width: (columns * btnWidth + (columns - 1) * gap), height: 70 };
            const allBtnId = 'start_all';
            const isAllHovered = currentHover === allBtnId;
            drawRoundedRect(allBtnRect.x, allBtnRect.y, allBtnRect.width, allBtnRect.height, 12, isAllHovered ? '#15803d' : '#16a34a', true);
            drawText('🚀 התחל מבחן על כל הנושאים', allBtnRect.x + allBtnRect.width / 2, allBtnRect.y + allBtnRect.height / 2, 'bold 24px Assistant', '#FFFFFF');
            clickableAreas.push({ ...allBtnRect, id: allBtnId, onClick: () => startQuiz('All') });

             // "Clear Save" button
            const clearBtnRect = { x: canvas.width / 2 - 150, y: allBtnRect.y + allBtnRect.height + 20, width: 300, height: 50 };
            const clearBtnId = 'clear_save';
            const isClearHovered = currentHover === clearBtnId;
            drawRoundedRect(clearBtnRect.x, clearBtnRect.y, clearBtnRect.width, clearBtnRect.height, 12, isClearHovered ? '#b91c1c' : COLORS.red, true);
            drawText('מחק שמירה והתחל מחדש', clearBtnRect.x + 150, clearBtnRect.y + 25, 'bold 20px Assistant', '#FFFFFF');
            clickableAreas.push({ ...clearBtnRect, id: clearBtnId, onClick: clearStateAndRestart });
        }

        function drawQuizScreen() {
            clickableAreas = [];
            const padding = 50;

            // Header
            const title = isReviewMode ? '🧠 סבב תיקון 🧠' : `נושא: ${currentCategory}`;
            drawText(title, canvas.width - padding, 50, 'bold 30px Assistant', COLORS.text, 'right');
            
            // --- SCORE CALCULATION ---
            let attemptedQuestions = currentQuestionIndex;
            // If the user has answered the current question, we count it as an attempt.
            if (answerSelected) {
                attemptedQuestions = currentQuestionIndex + 1;
            }
            
            let percentageScore = 0;
            if (attemptedQuestions > 0) {
                percentageScore = Math.round((score / attemptedQuestions) * 100);
            }
            drawText(`ציון: ${percentageScore}%`, padding, 50, 'bold 22px Assistant', COLORS.text, 'left');
            // --- END SCORE CALCULATION ---
            
            drawText(`שאלה ${currentQuestionIndex + 1} / ${currentQuiz.length}`, canvas.width / 2, 50, '22px Assistant', COLORS.lightText);

            // Progress Bar
            const progressBarY = 100;
            const progressBarWidth = canvas.width - 2 * padding;
            drawRoundedRect(padding, progressBarY, progressBarWidth, 12, 6, COLORS.border);
            const progress = currentQuiz.length > 0 ? (currentQuestionIndex / currentQuiz.length) * progressBarWidth : 0;
            if (progress > 0) {
                drawRoundedRect(padding, progressBarY, progress, 12, 6, COLORS.primary);
            }

            // Question
            const question = currentQuiz[currentQuestionIndex];
            if (!question) return;
            const questionInfo = wrapText(question.question, canvas.width - padding, 150, canvas.width - 2 * padding, 40, 'bold 28px Assistant', COLORS.text);
            let btnY = questionInfo.endY + 10;

            // Answer Options
            const btnWidth = (canvas.width - 3 * padding) / 2;
            const btnHeight = 75;
            
            question.options.forEach((option, index) => {
                const btnX = padding + (index % 2) * (btnWidth + padding);
                if (index === 2) btnY += btnHeight + 15;
                
                const btnId = `opt_${index}`;
                const rect = { x: btnX, y: btnY, width: btnWidth, height: btnHeight };
                let color = COLORS.lightGray;
                let textColor = COLORS.text;
                let isHovered = currentHover === btnId;

                if (answerSelected) {
                    if (option === question.correctAnswer) {
                        color = COLORS.green;
                        textColor = '#FFFFFF';
                    } else if (selectedAnswer === option) {
                        color = COLORS.red;
                        textColor = '#FFFFFF';
                    }
                } else if(isHovered) {
                    color = '#e5e7eb'; // gray-200
                }
                
                drawRoundedRect(rect.x, rect.y, rect.width, rect.height, 12, color, !answerSelected);
                wrapText(option, rect.x + rect.width - 20, rect.y + 15, rect.width - 40, 24, '18px Assistant', textColor);

                if (!answerSelected) {
                    clickableAreas.push({ ...rect, id: btnId, onClick: () => selectAnswer(option) });
                }
            });

            // Feedback and Explanation
            if (answerSelected) {
                let feedbackY = btnY + btnHeight + 40;
                let feedbackText = isCorrect ? 'נכון מאוד! ✔️' : 'תשובה שגויה... ❌';
                let feedbackColor = isCorrect ? COLORS.green : COLORS.red;
                drawText(feedbackText, canvas.width / 2, feedbackY, 'bold 24px Assistant', feedbackColor);

                const explanationY = feedbackY + 30;
                const explanationInfo = wrapText(question.explanation, canvas.width - padding - 15, explanationY + 15, canvas.width - 2 * padding - 30, 26, '18px Assistant', COLORS.text);
                const explanationHeight = (explanationInfo.lines * 26) + 30;
                const explanationRect = {x: padding, y: explanationY, width: canvas.width - 2 * padding, height: explanationHeight};
                drawRoundedRect(explanationRect.x, explanationRect.y, explanationRect.width, explanationRect.height, 8, COLORS.explanationBg);
                
                // Border on the right
                ctx.fillStyle = COLORS.primary;
                ctx.fillRect(explanationRect.x + explanationRect.width - 4, explanationRect.y, 4, explanationRect.height);
                
                // Re-draw text on top of rect
                 wrapText(question.explanation, canvas.width - padding - 15, explanationY + 15, canvas.width - 2 * padding - 30, 26, '18px Assistant', COLORS.text);


                // Next Button
                const nextBtnRect = { x: canvas.width / 2 - 100, y: canvas.height - 80, width: 200, height: 60 };
                const nextBtnId = 'next';
                const isNextHovered = currentHover === nextBtnId;
                drawRoundedRect(nextBtnRect.x, nextBtnRect.y, nextBtnRect.width, nextBtnRect.height, 12, isNextHovered ? '#2563eb' : COLORS.primary, true);
                drawText('השאלה הבאה', nextBtnRect.x + 100, nextBtnRect.y + 30, 'bold 22px Assistant', '#FFFFFF');
                clickableAreas.push({ ...nextBtnRect, id: nextBtnId, onClick: showNextQuestion });
            }
        }
        
        function drawEndScreen() {
            clickableAreas = [];
            const finalPercentage = currentQuiz.length > 0 ? Math.round((score / currentQuiz.length) * 100) : 0;
            const title = isReviewMode ? 'סיימת את סבב התיקון!' : 'המשחק הסתיים!';

            drawText(title, canvas.width / 2, 150, 'bold 40px Assistant', COLORS.text);
            drawText(`הציון הסופי שלך הוא:`, canvas.width / 2, 220, '28px Assistant', COLORS.lightText);
            drawText(`${score} / ${currentQuiz.length} (${finalPercentage}%)`, canvas.width / 2, 280, 'bold 48px Assistant', COLORS.primary);
            
            let btnY = 380;

            // Review Button
            if (incorrectQuestions.length > 0 && !isReviewMode) {
                const reviewBtnRect = { x: canvas.width / 2 - 175, y: btnY, width: 350, height: 70 };
                const reviewBtnId = 'review';
                const isReviewHovered = currentHover === reviewBtnId;
                drawRoundedRect(reviewBtnRect.x, reviewBtnRect.y, reviewBtnRect.width, reviewBtnRect.height, 12, isReviewHovered ? '#f59e0b' : COLORS.orange, true);
                drawText('🧠 תרגל שאלות שגויות', reviewBtnRect.x + 175, reviewBtnRect.y + 35, 'bold 22px Assistant', '#FFFFFF');
                clickableAreas.push({ ...reviewBtnRect, id: reviewBtnId, onClick: startReview });
                btnY += 90;
            }
            
            // Restart & Main Menu Buttons
            const restartBtnRect = { x: canvas.width / 2 + 10, y: btnY, width: 220, height: 60 };
            const restartBtnId = 'restart';
            const isRestartHovered = currentHover === restartBtnId;
            drawRoundedRect(restartBtnRect.x, restartBtnRect.y, restartBtnRect.width, restartBtnRect.height, 12, isRestartHovered ? '#2563eb' : COLORS.primary, true);
            drawText('שחק שוב', restartBtnRect.x + 110, restartBtnRect.y + 30, 'bold 20px Assistant', '#FFFFFF');
            clickableAreas.push({ ...restartBtnRect, id: restartBtnId, onClick: () => isReviewMode ? startReview() : startQuiz(currentCategory) });
            
            const menuBtnRect = { x: canvas.width / 2 - 230, y: btnY, width: 220, height: 60 };
            const menuBtnId = 'main_menu';
            const isMenuHovered = currentHover === menuBtnId;
            drawRoundedRect(menuBtnRect.x, menuBtnRect.y, menuBtnRect.width, menuBtnRect.height, 12, isMenuHovered ? '#15803d' : '#16a34a', true);
            drawText('תפריט ראשי', menuBtnRect.x + 110, menuBtnRect.y + 30, 'bold 20px Assistant', '#FFFFFF');
            clickableAreas.push({ ...menuBtnRect, id: menuBtnId, onClick: showMainMenu });
        }

        // --- Game Logic Functions ---
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function startQuiz(category) {
            currentCategory = category;
            isReviewMode = false;
            currentQuiz = (category === 'All') 
                ? shuffleArray([...allQuizData]) 
                : shuffleArray(allQuizData.filter(q => q.category === category));
            
            resetGameState();
            currentGameState = GameState.QUIZ;
            saveState();
        }
        
        function startReview() {
            isReviewMode = true;
            currentQuiz = shuffleArray([...incorrectQuestions]);
            resetGameState();
            currentGameState = GameState.QUIZ;
            saveState();
        }

        function resetGameState() {
            currentQuestionIndex = 0;
            score = 0;
            if (!isReviewMode) {
                incorrectQuestions = [];
            }
            answerSelected = false;
        }

        function selectAnswer(option) {
            if (answerSelected) return;
            
            const question = currentQuiz[currentQuestionIndex];
            selectedAnswer = option;
            isCorrect = (selectedAnswer === question.correctAnswer);
            answerSelected = true;

            if (isCorrect) {
                score++;
            } else if (!isReviewMode) {
                incorrectQuestions.push(question);
            }
            saveState();
        }

        function showNextQuestion() {
            if (currentQuestionIndex < currentQuiz.length - 1) {
                currentQuestionIndex++;
                answerSelected = false;
                selectedAnswer = null;
                isCorrect = false;
            } else {
                currentGameState = GameState.END_SCREEN;
            }
            saveState();
        }

        function showMainMenu() {
            currentGameState = GameState.MENU;
            saveState();
        }

        // --- Event Handlers ---
        function getMousePos(canvas, evt) {
            const rect = canvas.getBoundingClientRect();
            return {
                x: evt.clientX - rect.left,
                y: evt.clientY - rect.top
            };
        }
        
        function isPointInRect(x, y, rect) {
            return x > rect.x && x < rect.x + rect.width && y > rect.y && y < rect.y + rect.height;
        }
        
        canvas.addEventListener('mousemove', (evt) => {
            mousePos = getMousePos(canvas, evt);
        });

        canvas.addEventListener('click', (evt) => {
            const pos = getMousePos(canvas, evt);
            // Iterate backwards to prioritize foreground elements
            for (let i = clickableAreas.length - 1; i >= 0; i--) {
                const area = clickableAreas[i];
                if (isPointInRect(pos.x, pos.y, area)) {
                    area.onClick();
                    break; // Stop after finding one match
                }
            }
        });
        
        // --- Initial Call ---
        // Load font before starting the game
        document.fonts.load('10px Assistant').then(() => {
             loadState(); // Try to load saved game first
             gameLoop();
        });

    </script>
</body>
</html>
